name: Generate Examples

on:
  push:
    branches: [ master, main ]
    paths:
      - 'examples/*.png'
      - 'examples/*.bmp'
      - 'examples/*.jpg'
      - '.github/workflows/generate-examples.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-examples:
    name: Generate example images and documentation
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release

      - name: Build xbrzscale
        run: |
          cd build
          cmake --build . --config Release --target xbrzscale

      - name: Create output directory
        run: |
          if (Test-Path examples/upscaled) { Remove-Item -Recurse -Force examples/upscaled }
          New-Item -ItemType Directory -Path examples/upscaled

      - name: Upscale example images
        shell: pwsh
        run: |
          $images = @()
          $images += Get-ChildItem -Path examples -Filter *.png | Where-Object { $_.DirectoryName -notmatch 'upscaled' }
          $images += Get-ChildItem -Path examples -Filter *.bmp | Where-Object { $_.DirectoryName -notmatch 'upscaled' }
          $images += Get-ChildItem -Path examples -Filter *.jpg | Where-Object { $_.DirectoryName -notmatch 'upscaled' }

          foreach ($img in $images) {
            $basename = $img.BaseName
            $ext = $img.Extension
            Write-Host "Processing: $basename$ext"

            # Scale 2x, 3x, and 4x
            foreach ($scale in @(2, 3, 4)) {
              $output = "examples/upscaled/${basename}_${scale}x.png"
              Write-Host "  -> Scaling ${scale}x to $output"
              & build/Release/xbrzscale.exe $scale $img $output
            }
          }

      - name: Generate EXAMPLES.md
        shell: pwsh
        run: |
          $markdown = @"
          # xBRZ Examples

          This file is automatically generated by the GitHub Actions workflow. It shows before and after comparisons of images upscaled using the xBRZ algorithm.

          > **Note:** Images are upscaled using factors 2x, 3x, and 4x. Click on any image to view full size.

          ---

          "@

          $images = Get-ChildItem -Path examples -Filter *.png | Where-Object { $_.DirectoryName -notmatch 'upscaled' } | Sort-Object Name
          $images += Get-ChildItem -Path examples -Filter *.bmp | Where-Object { $_.DirectoryName -notmatch 'upscaled' } | Sort-Object Name
          $images += Get-ChildItem -Path examples -Filter *.jpg | Where-Object { $_.DirectoryName -notmatch 'upscaled' } | Sort-Object Name
          $images = $images | Sort-Object Name

          foreach ($img in $images) {
            $basename = $img.BaseName
            $filename = $img.Name

            # Get image dimensions using PowerShell
            Add-Type -AssemblyName System.Drawing
            $image = [System.Drawing.Image]::FromFile($img.FullName)
            $width = $image.Width
            $height = $image.Height
            $image.Dispose()

            $markdown += @"

          ## $filename

          **Original size:** ${width}x${height} pixels

          ### Original

          <img src="examples/$filename" alt="Original $filename" />

          ### 2x Upscale

          **Size:** $($width * 2)x$($height * 2) pixels

          <img src="examples/upscaled/${basename}_2x.png" alt="${basename} 2x upscaled" />

          ### 3x Upscale

          **Size:** $($width * 3)x$($height * 3) pixels

          <img src="examples/upscaled/${basename}_3x.png" alt="${basename} 3x upscaled" />

          ### 4x Upscale

          **Size:** $($width * 4)x$($height * 4) pixels

          <img src="examples/upscaled/${basename}_4x.png" alt="${basename} 4x upscaled" />

          ---

          "@
          }

          $markdown += @"


          ## About xBRZ

          xBRZ is a high-quality pixel art scaling algorithm designed to upscale low-resolution images while preserving sharp edges and avoiding blurriness. It's particularly well-suited for:

          - Pixel art from retro games
          - Low-resolution sprites and icons
          - Pixel-based graphics and animations

          The algorithm analyzes pixel patterns and applies intelligent interpolation to create smooth, natural-looking upscaled images.

          For more information, see: https://en.wikipedia.org/wiki/Pixel-art_scaling_algorithms#xBR_family

          ---

          *Last updated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')*

          *Generated by [GitHub Actions](https://github.com/$env:GITHUB_REPOSITORY/actions)*
          "@

          $markdown | Out-File -FilePath EXAMPLES.md -Encoding UTF8

      - name: Check for changes
        id: check-changes
        run: |
          git add examples/upscaled/ EXAMPLES.md
          $changes = git diff --staged --name-only
          if ($changes) {
            echo "has_changes=true" >> $env:GITHUB_OUTPUT
            Write-Host "Changes detected:"
            Write-Host $changes
          } else {
            echo "has_changes=false" >> $env:GITHUB_OUTPUT
            Write-Host "No changes detected"
          }

      - name: Commit and push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add examples/upscaled/ EXAMPLES.md
          git commit -m "Update examples gallery with upscaled images [skip ci]"
          git push
